<html metal:use-macro="load: ../base_layout.pt" lang="${request.locale_name}">

<body>
<metal:block fill-slot="content">

    <div class="container">
        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <ol class="breadcrumb">
                    <li><a href="/">Home</a></li>
                    <li>HLA Browser</li>
                    <li>HLA-${hla}</li>
                </ol>
            </div>
        </div>
        <div class="row">
            <div class="col-md-10 col-md-offset-1 text-center">
                <h1 id="title">HLA-${hla}</h1>
            </div>
        </div>



        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <!-- Creating tabs -->
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#dbcontent" data-toggle="tab">Statistics</a></li>
                    <li><a href="#tissuepiechart" data-toggle="tab">Distribution of tissues</a></li>
                </ul>
                <div class="tab-content">

                    <!-- Statistics-->
                    <div class="tab-pane fade in active" id="dbcontent">
                        <div style="min-width: 50%;  max-width: 50%;height: 400px;">
                            <br>
                            <table class="table table-striped table-bordered">
                                <tr>
                                    <td>Binding peptides</td>
                                    <td id="bindpep_stat" align="right"></td>
                                </tr>
                                <tr>
                                    <td>Sources</td>
                                    <td id="source_stat" align="right"></td>
                                </tr>
                                <tr>
                                    <td>Samples</td>
                                    <td id="sample_stat" align="right"></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Tissue chart -->
                    <div class="tab-pane fade" id="tissuepiechart">
                        <div id="tissue_chart"
                             style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>
                    </div>

                </div>
            </div>

        </div>

        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <div id="distribution" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
            </div>
        </div>

        <!-- Peptide-binding motif -->
        <div class="row" tal:condition="not hla.startswith('D')">
            <div class="col-md-10 col-md-offset-1">
            <h1>Peptide binding motif</h1>
                <!-- Creating tabs -->
                <ul class="nav nav-tabs" id="seqlogo_tabs">

                </ul>
                <div class="tab-content" id="seqlogo_content">


                </div>
            </div>
        </div>

    </div>

    <script>


        //tissue pie chart
        var date = new Date();
        $(document).ready(function () {
            $('#tissue_chart').highcharts({
                // var options =  {
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie'
                },
                xAxis: {
                    title: {text: "Tissue"}
                },
                credits: {
                    enabled: false
                },
                //TITLE REMOVED TO FIT THEME, NO DIFFERENT FONTS
                title: {
                    text: ''
                },
                exporting: {
                    chartOptions: {
                         title: {
                            text: 'Distribution of tissues for HLA-${hla}'
                        },
                        subtitle: {
                            text: "Source: " + document.URL + ", " + date.toUTCString() ,
                            align: "left",
                            verticalAlign: "bottom",
                            y: 10
                        }
                    },
                    filename: "DistributionOfTissues_HLA-${hla}"
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.y}</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        showInLegend: false,
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.y} '
                        },
                        style: {
                            color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                        }
                    }
                },
                series: [{
                    name: 'Number of sources',
                    colorByPoint: true,
                    point: {
                        events: {
                            click: function () {
                                window.location.href = "/organ_hla/" + this.name+ "$${hla}";
                            }
                        }
                    },
                    data: ${organ}
                }]
            });
        });

        var min_len  = 8;
        var max_len = 10;
        var peptide_distribution_array = {};
        for(var i = 0; i<${peptide_distribution}.length; i++){
            peptide_distribution_array[${peptide_distribution}[i]["length"]] = ${peptide_distribution}[i]["count"];
            if(${peptide_distribution}[i]["count"]>10){
                min_len = Math.min(min_len, ${peptide_distribution}[i]["length"]);
                max_len = Math.max(max_len, ${peptide_distribution}[i]["length"]);
            }
        }


        $(document).ready(function () {
            // set statistics
            document.getElementById("bindpep_stat").innerHTML = "<a title='Show all Peptides'  class='nostylelink' href='javascript:post(\x22../peptide_query\x22, {hla_typing: \x22${hla}\x22, grouping:\x22peptide\x22}," + ${statistic}[0]["binding_peptide_count"] + " )'> " + ${statistic}[0]["binding_peptide_count"] + "</a>";
            document.getElementById("source_stat").innerHTML = ${sources}.length;
            document.getElementById("sample_stat").innerHTML = ${statistic}[0]["sample_count"];


            if('${hla}'.indexOf("D") == -1 ){
                var any_seqlogo = false;
                for(i = min_len; i <= max_len; i++) {

                    if(peptide_distribution_array[i]>10) {
                        any_seqlogo =true;
                        if (i == 9) {
                            $("#seqlogo_tabs").append('<li class="active"><a href="#' + i + 'mer" data-toggle="tab">' + i + 'mer</a></li>');

                            $("#seqlogo_content").append('<div class="tab-pane fade in active" id="'+ i +'mer">' +
                                '<div style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto">' +
                                '<img style="height: 400px; display: block; text-align: center; line-height: 100px; ' + /* needed to align alternative text */
                                'vertical-align: middle; margin: 0 auto" id="seqlogo_'+ i +'" src="" alt="No peptide-binding motif available yet.">' +
                                '</div>' +
                                '</div>'
                            )

                        } else {
                            $("#seqlogo_tabs").append('<li ><a href="#' + i + 'mer" data-toggle="tab">' + i + 'mer</a></li>');
                            $("#seqlogo_content").append('<div class="tab-pane fade" id="'+ i +'mer">' +
                                '<div style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto">' +
                                '<img style="height: 400px; display: block; text-align: center; line-height: 100px; ' + /* needed to align alternative text */
                                'vertical-align: middle; margin: 0 auto" id="seqlogo_'+ i +'" src="" alt="No peptide-binding motif available yet.">' +
                                '</div>' +
                                '</div>'
                            )
                        }

                        temppath = "${request.static_url("ligando:static/seqlogo/A_0101.png")}";
                        document.getElementById("seqlogo_"+i).src =  temppath.slice(0, -10)+ "test/" + '${hla}'.replace(":", "").replace("*","_") + "_"+i+".png";
                    }else {
                        $("#seqlogo_tabs").append('<li class="disabled"><a href="#' + i + 'mer" data-toggle="tab">' + i + 'mer</a></li>');
                        $("#seqlogo_content").append('<div class="tab-pane fade in active" id="' + i + 'mer">' +
                                '<div style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto">' +
                                '<img style="height: 400px; display: block; text-align: center; line-height: 100px; ' + /* needed to align alternative text */
                                'vertical-align: middle; margin: 0 auto" id="seqlogo_' + i + '" src="" alt="No peptide-binding motif available yet.">' +
                                '</div>' +
                                '</div>'
                        )
                    }
                }





            }

            /*<li class="active"><a href="#9mer" data-toggle="tab">9mer</a></li>
                    <li><a href="#10mer" data-toggle="tab">10mer</a></li>
                    <li><a href="#11mer" data-toggle="tab">11mer</a></li>
                    <li><a href="#12mer" data-toggle="tab">12mer</a></li>*/

            // set the corresponding seqlogo
            for(i = min_len; i <= max_len; i++){
                //url = "ligando:static/seqlogo/test/" +'${hla}'.replace(":", "").replace("*","_")+"_"+i + ".png"



            }

        });



        // Date of visit
        var date = new Date();
        // Peptide length distribution for hla
        $(document).ready(function () {

            var options = {
                chart: {
                    type: 'column'
                },
                credits: {
                    enabled: false
                },
                title: {
                    text: 'Peptide length distribution for ' + '${hla}'
                },
                exporting: {
                    chartOptions: {
                         title: {
                            text: 'Peptide length distribution for ' + '${hla}'
                        },
                        subtitle: {
                            text: "Source: " + document.URL + ", " + date.toUTCString() ,
                            align: "left",
                            verticalAlign: "bottom",
                            y: 10
                        }
                    },
                    filename: 'Peptide length distribution for ' + '${hla}'
                },
                xAxis: {
                    type: [],
                    title: {
                        text: 'Length'
                    }
                },
                yAxis: {
                    title: {
                        text: 'Number of Peptides'
                    }
                },
                series: [],
                tooltip: {
                    formatter: function () {
                        return '<b>' + this.x +
                                ' : ' + this.y + '</b>';
                    }
                }

            };

            protein_stats = ${peptide_distribution};
            var series = {
                name: ["Number of Peptides"],
                data: [],
                showInLegend: false,
                point: {
                        events: {
                            click: function () {
                             post("../peptide_query", {hla_typing: "${hla}", grouping:"peptide", length_1: this.category-1, length_2: (this.category +1)}, this.y)
                            }
                        }
                    }
            };
            var categories = [];
            $.each(protein_stats, function (i, row) {
                categories.push(parseInt(row["length"]));
                //series.name.push(row["gene_name"]+"/"+ row["name"]);
                series.data.push(parseInt(row["count"]));

            });
            options.series.push(series);
            options.xAxis.categories = categories;


            $('#distribution').highcharts(options);
        });

    </script>

</metal:block>
</body>

</html>